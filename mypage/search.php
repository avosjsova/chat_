<?php	include 'madrid.php';	$connection=mysql_connect("192.168.2.226", "student", "stu") or die("Cant connect to database server");	mysql_select_db("test") or die("Could not select database");	$LG = $_COOKIE['id_users'];	if (!$LG)	{		//header('Location: index.php');		exit();	}	$staff_q = "SELECT * FROM staff WHERE login ='".$LG."' LIMIT 1";	$staff_r = mysql_query($staff_q) or die("Query failed");	$res = mysql_fetch_assoc($staff_r);	$content = '';?><html style="font-family:calibri;background:#EEEEEE;color:#741147;"><head>	<title>		<? echo UTF('Контроль работников')?>	</title></head><body>	<form name="srch" method="post" action="search.php" align="center">	<table align="center" width="741">				<tbody>				<tr>					<td align="right">					<table cellpadding="10" align="center">						<tbody>							<!-- кнопочки слева-->							<tr>								<td align="right">									<div onMouseOver="MOver(this)" onMouseOut="MOut(this)" style="color:#147741" onclick="go('profile.php', srch)"><? echo UTF("Главная страница");?></div>								</td>								<td align="right">									<div onMouseOver="MOver(this)" onMouseOut="MOut(this)" style="color:#147741" onclick='go("my_msgs.php?act=outbox",srch)'><? echo UTF("Мои сообщения");?></div>								</td>								<td align="right">									<div onMouseOver="MOver(this)" onMouseOut="MOut(this)" style="color:#147741" onclick='go("send_msg.php", srch)'  ><? echo UTF("Отправить сообщение");?></div>								</td>								<?									if($res['type'])										$content .= '<td align="right">														<div onMouseOver="MOver(this)" onMouseOut="MOut(this)" style="color:#147741" onclick="go(\'search.php\', srch)"  >'.UTF("Поиск сообщений").'</div>													</td>';										else									{										header('Location: index.php');										exit();									}										echo $content;								?>								<td align="right">									<input  style="color:#147741" onMouseOver="MOver(this)" onMouseOut="MOut(this)" name="lg" align="right" type="button" value="<? echo UTF("Выйти");?>" onClick='go("logout.php",srch)'>								</td>							</tr>						</tbody>					</table>					</td>				</tr>				<tr>					<td>					<table style="color:#147741" cellspacing="10" align="center">						<tbody>							<tr style="color:#741147">								<td colspan="2" align="center">									<h2><? echo UTF("Выберите проект и сотрудника (в разработке)");?></h2>								</td>							</tr>							<tr>								<td valign="top" align="right">									<? echo UTF("Проект");?>								</td>								<td>									<select onMouseOver="MOver(this)" onMouseOut="MOut(this)" style="color:#147741;width:200" onChange="proj(this,id_staff)" name="id_project">									<?										$content = '';										$proj_q = "SELECT * FROM project";										$proj_r = mysql_query($proj_q);										// Загрузка списка проектов										$k = -1;										while($proj = mysql_fetch_array($proj_r))										{											$k++;											$content .= '<option value="'.$proj["id_project"].'">'.$proj["name"].'</option>';											if(!$k)												$SLCTD_PR = $proj['id_project'];										}										echo $content;									?>									</select>								</td>							</tr>							<tr>								<td valign="top"  align="right">									<? echo UTF("Сотрудник");?>								</td>								<td>									<select onMouseOver="MOver(this)" onMouseOut="MOut(this)" style="color:#147741;width:200" name="id_staff">									<?										$content = '';										$stf_k = 0;										if(isset($_GET['act']))										{											$SLCTD_PR = $_GET['act'];										}																				// Выводим список всех сотрудников, кроме авторизованного пользователя										$list_q = "SELECT * FROM projects WHERE id_project = '".$SLCTD_PR."' AND (id_staff!='".$res['id_staff']."')";										$list_r = mysql_query($list_q);										while($list = mysql_fetch_array($list_r))										{											$stf_k++;											$stf_q = "SELECT * FROM staff WHERE id_staff = '".$list['id_staff']."' LIMIT 1";											$stf_r = mysql_query($stf_q);											$stf = mysql_fetch_assoc($stf_r);											$content .= '<option value="'.$stf["id_staff"].'">'.$stf['name'].'</option>';										}										echo $content;										echo $stf_k;									?>									</select>								</td>												</tr>							<tr>								<td valign="top" align="center" colspan="2">									 <? echo UTF("Опции времени");?>								</td>							</tr>							<tr>								<td style="color:#147741" onMouseOver="MOver(this)" onMouseOut="MOut(this)" valign="top" align = "left">									<input type="radio" id = "dt" name="dt" value="det" checked>									<label for="dt"> <? echo UTF("Дата");?> </label>								</td>								<td>									<input type="date" name="det_date">								</td>							</tr>							<tr>								<td style="color:#147741" onMouseOver="MOver(this)" onMouseOut="MOut(this)" valign="top" align = "left">									<input type="radio" name="dt" value="period" id="dt">									<label for="per"> <? echo UTF("С");?> </label>								</td>								<td> 									<input type="date" name="bdate">									<? echo UTF("по");?> <input type="date" name="edate">								</td>							</tr>							<tr>								<td align="right" colspan="2">									<input style="color:#147741" onMouseOver="MOver(this)" onMouseOut="MOut(this)" type="submit" name="srch1" value="<? echo UTF("Выполнить поиск");?>" onclick="searching(this)"></input> 														</td>							</tr>						</tbody>					</table>					</td>				</tr>				<tr>					<td align="center">					<?						$content = '';						$SRCH = $_POST['srch1'];						if($SRCH == 'Searching...')						{							$SNDR = $_POST['id_staff'];							$SLCTD_PR = $_POST['id_project'];							$sel_pr = mysql_fetch_assoc(mysql_query("SELECT * FROM project WHERE id_project='".$SLCTD_PR."' LIMIT 1"));							$s = mysql_fetch_assoc(mysql_query("SELECT * FROM staff WHERE id_staff='".$SNDR."' LIMIT 1"));							$content .= '<h2>'.UTF("Выбран пользователь ").''.$s['name'].UTF(" и проект ").$sel_pr['name'].'</h2>';														$msgs_q = "SELECT * FROM messages WHERE id_sender='".$SNDR."' ORDER BY sdate DESC";							$msgs_r = mysql_query($msgs_q);							$stf_k = 0;							while($m = mysql_fetch_array($msgs_r))							{								$stf_k++;							}							$content .= '								<table width=500 align="center" cellpadding="5" style="background:#C2C2C2;color:#147741;width:1000" border="2">									<tbody>';							if($stf_k)							{																$content .= '								<table width=500 align="center" cellpadding="5" style="background:#C2C2C2;color:#147741;width:1000">									<tbody>										<tr>											<td width=30>												'.UTF("Когда отправлено").'											</td>											<td width=70>												'.UTF("Кому отправлено").'											</td>											<td width=250>												'.UTF("Текст").'											</td>										</tr>';								$msgs_q = "SELECT * FROM messages WHERE id_sender='".$SNDR."' ORDER BY sdate DESC";								$msgs_r = mysql_query($msgs_q);								while($msgs = mysql_fetch_array($msgs_r))								{									$pr_q = "SELECT * FROM project WHERE id_project = '".$msgs['id_project']."' LIMIT 1";									$pr_r = mysql_query($pr_q);									$pr = mysql_fetch_assoc($pr_r);																		$sndr_q = "SELECT * FROM staff WHERE id_staff ='".$msgs['id_sender']."' LIMIT 1";									$sndr_r = mysql_query($sndr_q);									$sndr = mysql_fetch_assoc($sndr_r);																		$rcvr_q = "SELECT * FROM staff WHERE id_staff ='".$msgs['id_reciever']."' LIMIT 1";									$rcvr_r = mysql_query($rcvr_q);									$rcvr = mysql_fetch_assoc($rcvr_r);																		$dt = date("d.m.Y  H:i:s",strtotime($msgs['sdate']));									$arr_txt = str_split($msgs['text']);									$txt = '';									for($i=0;$i<strlen($msgs['text']);$i++)									{										$txt .= $arr_txt[$i];										if(ord($arr_txt[$i]) == 10)											$txt .= '<br/>';									}									$bckgrnd = $msgs['read_msg']?'#EAEAEA':'#AEAEAE'; 									$content .= '<tr name="a" style="background:'.$bckgrnd.';color:#770077" onMouseOver="X(this,\'#CCCCCC\')" onMouseOut="X(this,\''.$bckgrnd.'\')">														<td valign=top width=30>															'.$dt.'														</td>															<td valign=top width=20>															'.$rcvr['name'].'														</td>															<td valign=top width=150>															'.$txt.'														</td>														</tr>';								}							}							else							{								$content .='<tr><td colspan=4 align="center"><h2 align="center" style="color:#147741">'.UTF("Поиск не дал результатов").' </h2></td></tr>';							}							$content .='									</tbody>								</table>							';							echo $content;						}					?>										</td>				</tr>			</tbody>		</table>	</form>		<script language="javascript" src="madrid.js"></script>		<script>			<? 				if(isset($_GET['act']))					echo 'document.srch.id_project.value =  "'.$_GET['act'].'";';				if(isset($_GET['sel']))					echo 'document.srch.id_staff.value =  "'.$_GET['sel'].'";';			?>			function searching(that)			{				that.value = "Searching..."				document.srch.action = "search.php?act="+document.srch.id_project.value+"&?sel="+document.srch.id_staff.value;				alert(document.srch.dt.value);			}						function fix(that)			{				that.checked = true;			}			function proj(that,other)			{				document.srch.action = "search.php?act="+that.value;				document.srch.submit();			}		</script>	</body></html>